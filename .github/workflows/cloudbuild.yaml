steps:
  # 1. Terraform Init
  - id: 'terraform-init'
    name: 'hashicorp/terraform:1.6.0'
    args: ['init']
    dir: 'infra'

  # 2. Terraform Validate
  - id: 'terraform-validate'
    name: 'hashicorp/terraform:1.6.0'
    args: ['validate']
    dir: 'infra'

  # 3. Terraform Plan (sempre roda e gera o tfplan)
  - id: 'terraform-plan'
    name: 'hashicorp/terraform:1.6.0'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "üîç Running plan with environment: ${_TF_ENV}"
        terraform plan \
          -var-file=${_TF_ENV_PATH} \
          -out=tfplan
    dir: 'infra'

  # 4. Terraform Apply (s√≥ em develop ou main)
  - id: 'terraform-apply'
    name: 'hashicorp/terraform:1.6.0'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        if [ "$BRANCH_NAME" = "develop" ] || [ "$BRANCH_NAME" = "main" ]; then
          echo "üöÄ Applying terraform on branch $BRANCH_NAME"
          terraform apply -auto-approve tfplan
        else
          echo "‚è≠Ô∏è Skipping apply for branch $BRANCH_NAME"
        fi
    dir: 'infra'

options:
  logging: CLOUD_LOGGING_ONLY